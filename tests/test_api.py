"""
Tests unitaires pour l'API de scoring
"""
import pytest
from fastapi.testclient import TestClient
from api.main import app, load_model

# Créer un client de test
client = TestClient(app)


@pytest.fixture(scope="module", autouse=True)
def setup_model():
    """
    Charge le modèle avant d'exécuter les tests
    """
    load_model()


def test_health_check():
    """
    Test du health check
    """
    response = client.get("/health")
    assert response.status_code == 200
    data = response.json()
    assert "status" in data
    assert "model_loaded" in data
    assert data["model_loaded"] is True


def test_predict_valid_input():
    """
    Test de prédiction avec des données valides
    """
    payload = {
  "ACTIVE_AMT_CREDIT_MAX_OVERDUE_MEAN": 7195.5,
  "ACTIVE_AMT_CREDIT_SUM_MAX": 450000,
  "ACTIVE_DAYS_CREDIT_MAX": -753,
  "AMT_ANNUITY": 10548,
  "AMT_CREDIT": 148365,
  "AMT_GOODS_PRICE": 135000,
  "ANNUITY_INCOME_PERC": 0.1019130434782608,
  "APPROVED_AMT_ANNUITY_MEAN": 6340.785,
  "APPROVED_CNT_PAYMENT_MEAN": 14.666666666666666,
  "APPROVED_DAYS_DECISION_MAX": -348,
  "BURO_AMT_CREDIT_MAX_OVERDUE_MEAN": 7195.5,
  "BURO_AMT_CREDIT_SUM_DEBT_MEAN": 0,
  "BURO_DAYS_CREDIT_MAX": -753,
  "BURO_DAYS_CREDIT_MEAN": -979.6666666666666,
  "CC_CNT_DRAWINGS_ATM_CURRENT_MEAN": 0.2666666666666666,
  "CLOSED_AMT_CREDIT_SUM_MAX": 38650.5,
  "CLOSED_DAYS_CREDIT_ENDDATE_MAX": -943,
  "CLOSED_DAYS_CREDIT_MAX": -1065,
  "CLOSED_DAYS_CREDIT_VAR": 256328,
  "CODE_GENDER": 1,
  "DAYS_BIRTH": -11716,
  "DAYS_EMPLOYED": -449,
  "DAYS_EMPLOYED_PERC": 0.0383236599522021,
  "DAYS_ID_PUBLISH": -3961,
  "DAYS_LAST_PHONE_CHANGE": -1420,
  "DAYS_REGISTRATION": -3997,
  "EXT_SOURCE_1": 0.3608707365728421,
  "EXT_SOURCE_2": 0.4285392216965799,
  "EXT_SOURCE_3": 0.7981372313187245,
  "INSTAL_AMT_PAYMENT_MEAN": 10274.82081081081,
  "INSTAL_AMT_PAYMENT_MIN": 2.7,
  "INSTAL_AMT_PAYMENT_SUM": 380168.37,
  "INSTAL_DBD_MAX": 60,
  "INSTAL_DBD_SUM": 833,
  "INSTAL_DPD_MEAN": 0.4594594594594595,
  "INSTAL_PAYMENT_PERC_MEAN": 0.945945945945946,
  "OWN_CAR_AGE": 9,
  "PAYMENT_RATE": 0.0710949347892023,
  "POS_MONTHS_BALANCE_SIZE": 40,
  "PREV_CNT_PAYMENT_MEAN": 15.142857142857142
}
    
    response = client.post("/predict", json=payload)
    assert response.status_code == 200
    
    data = response.json()
    assert "client_id" in data
    assert "score" in data
    assert "decision" in data
    assert "confidence" in data
    assert "inference_time_ms" in data
    
    # Vérifier les types et ranges
    assert 0 <= data["score"] <= 1
    assert data["decision"] in ["APPROVED", "REJECTED"]
    assert 0 <= data["confidence"] <= 1
    assert data["inference_time_ms"] > 0


def test_predict_invalid_age():
    """
    Test avec un âge invalide (trop jeune)
    """
    payload = {
  "ACTIVE_AMT_CREDIT_MAX_OVERDUE_MEAN": 7195.5,
  "ACTIVE_AMT_CREDIT_SUM_MAX": 450000,
  "ACTIVE_DAYS_CREDIT_MAX": -753,
  "AMT_ANNUITY": 10548,
  "AMT_CREDIT": 148365,
  "AMT_GOODS_PRICE": 135000,
  "ANNUITY_INCOME_PERC": 0.1019130434782608,
  "APPROVED_AMT_ANNUITY_MEAN": 6340.785,
  "APPROVED_CNT_PAYMENT_MEAN": 14.666666666666666,
  "APPROVED_DAYS_DECISION_MAX": -348,
  "BURO_AMT_CREDIT_MAX_OVERDUE_MEAN": 7195.5,
  "BURO_AMT_CREDIT_SUM_DEBT_MEAN": 0,
  "BURO_DAYS_CREDIT_MAX": -753,
  "BURO_DAYS_CREDIT_MEAN": -979.6666666666666,
  "CC_CNT_DRAWINGS_ATM_CURRENT_MEAN": 0.2666666666666666,
  "CLOSED_AMT_CREDIT_SUM_MAX": 38650.5,
  "CLOSED_DAYS_CREDIT_ENDDATE_MAX": -943,
  "CLOSED_DAYS_CREDIT_MAX": -1065,
  "CLOSED_DAYS_CREDIT_VAR": 256328,
  "CODE_GENDER": 1,
  "DAYS_BIRTH": -5400, # TROP JEUNE
  "DAYS_EMPLOYED": -449,
  "DAYS_EMPLOYED_PERC": 0.0383236599522021,
  "DAYS_ID_PUBLISH": -3961,
  "DAYS_LAST_PHONE_CHANGE": -1420,
  "DAYS_REGISTRATION": -3997,
  "EXT_SOURCE_1": 0.3608707365728421,
  "EXT_SOURCE_2": 0.4285392216965799,
  "EXT_SOURCE_3": 0.7981372313187245,
  "INSTAL_AMT_PAYMENT_MEAN": 10274.82081081081,
  "INSTAL_AMT_PAYMENT_MIN": 2.7,
  "INSTAL_AMT_PAYMENT_SUM": 380168.37,
  "INSTAL_DBD_MAX": 60,
  "INSTAL_DBD_SUM": 833,
  "INSTAL_DPD_MEAN": 0.4594594594594595,
  "INSTAL_PAYMENT_PERC_MEAN": 0.945945945945946,
  "OWN_CAR_AGE": 9,
  "PAYMENT_RATE": 0.0710949347892023,
  "POS_MONTHS_BALANCE_SIZE": 40,
  "PREV_CNT_PAYMENT_MEAN": 15.142857142857142
}
    
    response = client.post("/predict", json=payload)
    assert response.status_code == 422  # Validation error


def test_predict_negative_income():
    """
    Test avec un revenu négatif
    """
    payload = {
  "ACTIVE_AMT_CREDIT_MAX_OVERDUE_MEAN": 7195.5,
  "ACTIVE_AMT_CREDIT_SUM_MAX": 450000,
  "ACTIVE_DAYS_CREDIT_MAX": -753,
  "AMT_ANNUITY": 10548,
  "AMT_CREDIT": 148365,
  "AMT_GOODS_PRICE": 135000,
  "ANNUITY_INCOME_PERC": 0.1019130434782608,
  "APPROVED_AMT_ANNUITY_MEAN": 6340.785,
  "APPROVED_CNT_PAYMENT_MEAN": 14.666666666666666,
  "APPROVED_DAYS_DECISION_MAX": -348,
  "BURO_AMT_CREDIT_MAX_OVERDUE_MEAN": 7195.5,
  "BURO_AMT_CREDIT_SUM_DEBT_MEAN": 0,
  "BURO_DAYS_CREDIT_MAX": -753,
  "BURO_DAYS_CREDIT_MEAN": -979.6666666666666,
  "CC_CNT_DRAWINGS_ATM_CURRENT_MEAN": 0.2666666666666666,
  "CLOSED_AMT_CREDIT_SUM_MAX": 38650.5,
  "CLOSED_DAYS_CREDIT_ENDDATE_MAX": -943,
  "CLOSED_DAYS_CREDIT_MAX": -1065,
  "CLOSED_DAYS_CREDIT_VAR": 256328,
  "CODE_GENDER": 1,
  "DAYS_BIRTH": -11716,
  "DAYS_EMPLOYED": -449,
  "DAYS_EMPLOYED_PERC": 0.0383236599522021,
  "DAYS_ID_PUBLISH": -3961,
  "DAYS_LAST_PHONE_CHANGE": -1420,
  "DAYS_REGISTRATION": -3997,
  "EXT_SOURCE_1": 0.3608707365728421,
  "EXT_SOURCE_2": 0.4285392216965799,
  "EXT_SOURCE_3": 0.7981372313187245,
  "INSTAL_AMT_PAYMENT_MEAN": 10274.82081081081,
  "INSTAL_AMT_PAYMENT_MIN": 2.7,
  "INSTAL_AMT_PAYMENT_SUM": 380168.37,
  "INSTAL_DBD_MAX": 60,
  "INSTAL_DBD_SUM": 833,
  "INSTAL_DPD_MEAN": 0.4594594594594595,
  "INSTAL_PAYMENT_PERC_MEAN": 0.945945945945946,
  "OWN_CAR_AGE": 9,
  "PAYMENT_RATE": -1, # NEGATIF
  "POS_MONTHS_BALANCE_SIZE": 40,
  "PREV_CNT_PAYMENT_MEAN": 15.142857142857142
}
    
    response = client.post("/predict", json=payload)
    assert response.status_code == 422  # Validation error


def test_predict_missing_field():
    """
    Test avec un champ manquant
    """
    payload = {
  #"ACTIVE_AMT_CREDIT_MAX_OVERDUE_MEAN": 7195.5,
  "ACTIVE_AMT_CREDIT_SUM_MAX": 450000,
  "ACTIVE_DAYS_CREDIT_MAX": -753,
  "AMT_ANNUITY": 10548,
  "AMT_CREDIT": 148365,
  "AMT_GOODS_PRICE": 135000,
  "ANNUITY_INCOME_PERC": 0.1019130434782608,
  "APPROVED_AMT_ANNUITY_MEAN": 6340.785,
  "APPROVED_CNT_PAYMENT_MEAN": 14.666666666666666,
  "APPROVED_DAYS_DECISION_MAX": -348,
  "BURO_AMT_CREDIT_MAX_OVERDUE_MEAN": 7195.5,
  "BURO_AMT_CREDIT_SUM_DEBT_MEAN": 0,
  "BURO_DAYS_CREDIT_MAX": -753,
  "BURO_DAYS_CREDIT_MEAN": -979.6666666666666,
  "CC_CNT_DRAWINGS_ATM_CURRENT_MEAN": 0.2666666666666666,
  "CLOSED_AMT_CREDIT_SUM_MAX": 38650.5,
  "CLOSED_DAYS_CREDIT_ENDDATE_MAX": -943,
  "CLOSED_DAYS_CREDIT_MAX": -1065,
  "CLOSED_DAYS_CREDIT_VAR": 256328,
  "CODE_GENDER": 1,
  "DAYS_BIRTH": -11716,
  "DAYS_EMPLOYED": -449,
  "DAYS_EMPLOYED_PERC": 0.0383236599522021,
  "DAYS_ID_PUBLISH": -3961,
  "DAYS_LAST_PHONE_CHANGE": -1420,
  "DAYS_REGISTRATION": -3997,
  "EXT_SOURCE_1": 0.3608707365728421,
  "EXT_SOURCE_2": 0.4285392216965799,
  "EXT_SOURCE_3": 0.7981372313187245,
  "INSTAL_AMT_PAYMENT_MEAN": 10274.82081081081,
  "INSTAL_AMT_PAYMENT_MIN": 2.7,
  "INSTAL_AMT_PAYMENT_SUM": 380168.37,
  "INSTAL_DBD_MAX": 60,
  "INSTAL_DBD_SUM": 833,
  "INSTAL_DPD_MEAN": 0.4594594594594595,
  "INSTAL_PAYMENT_PERC_MEAN": 0.945945945945946,
  "OWN_CAR_AGE": 9,
  "PAYMENT_RATE": 0.0710949347892023,
  "POS_MONTHS_BALANCE_SIZE": 40,
  "PREV_CNT_PAYMENT_MEAN": 15.142857142857142
}
    
    response = client.post("/predict", json=payload)
    assert response.status_code == 500  # Validation error


def test_predict_multiple_requests():
    """
    Test de plusieurs prédictions successives (charge)
    """
    payload = {
  "ACTIVE_AMT_CREDIT_MAX_OVERDUE_MEAN": 7195.5,
  "ACTIVE_AMT_CREDIT_SUM_MAX": 450000,
  "ACTIVE_DAYS_CREDIT_MAX": -753,
  "AMT_ANNUITY": 10548,
  "AMT_CREDIT": 148365,
  "AMT_GOODS_PRICE": 135000,
  "ANNUITY_INCOME_PERC": 0.1019130434782608,
  "APPROVED_AMT_ANNUITY_MEAN": 6340.785,
  "APPROVED_CNT_PAYMENT_MEAN": 14.666666666666666,
  "APPROVED_DAYS_DECISION_MAX": -348,
  "BURO_AMT_CREDIT_MAX_OVERDUE_MEAN": 7195.5,
  "BURO_AMT_CREDIT_SUM_DEBT_MEAN": 0,
  "BURO_DAYS_CREDIT_MAX": -753,
  "BURO_DAYS_CREDIT_MEAN": -979.6666666666666,
  "CC_CNT_DRAWINGS_ATM_CURRENT_MEAN": 0.2666666666666666,
  "CLOSED_AMT_CREDIT_SUM_MAX": 38650.5,
  "CLOSED_DAYS_CREDIT_ENDDATE_MAX": -943,
  "CLOSED_DAYS_CREDIT_MAX": -1065,
  "CLOSED_DAYS_CREDIT_VAR": 256328,
  "CODE_GENDER": 1,
  "DAYS_BIRTH": -11716,
  "DAYS_EMPLOYED": -449,
  "DAYS_EMPLOYED_PERC": 0.0383236599522021,
  "DAYS_ID_PUBLISH": -3961,
  "DAYS_LAST_PHONE_CHANGE": -1420,
  "DAYS_REGISTRATION": -3997,
  "EXT_SOURCE_1": 0.3608707365728421,
  "EXT_SOURCE_2": 0.4285392216965799,
  "EXT_SOURCE_3": 0.7981372313187245,
  "INSTAL_AMT_PAYMENT_MEAN": 10274.82081081081,
  "INSTAL_AMT_PAYMENT_MIN": 2.7,
  "INSTAL_AMT_PAYMENT_SUM": 380168.37,
  "INSTAL_DBD_MAX": 60,
  "INSTAL_DBD_SUM": 833,
  "INSTAL_DPD_MEAN": 0.4594594594594595,
  "INSTAL_PAYMENT_PERC_MEAN": 0.945945945945946,
  "OWN_CAR_AGE": 9,
  "PAYMENT_RATE": 0.0710949347892023,
  "POS_MONTHS_BALANCE_SIZE": 40,
  "PREV_CNT_PAYMENT_MEAN": 15.142857142857142
}
    
    for _ in range(10):
        response = client.post("/predict", json=payload)
        assert response.status_code == 200


def test_api_response_time():
    """
    Test du temps de réponse de l'API
    """
    import time
    
    payload = {
  "ACTIVE_AMT_CREDIT_MAX_OVERDUE_MEAN": 7195.5,
  "ACTIVE_AMT_CREDIT_SUM_MAX": 450000,
  "ACTIVE_DAYS_CREDIT_MAX": -753,
  "AMT_ANNUITY": 10548,
  "AMT_CREDIT": 148365,
  "AMT_GOODS_PRICE": 135000,
  "ANNUITY_INCOME_PERC": 0.1019130434782608,
  "APPROVED_AMT_ANNUITY_MEAN": 6340.785,
  "APPROVED_CNT_PAYMENT_MEAN": 14.666666666666666,
  "APPROVED_DAYS_DECISION_MAX": -348,
  "BURO_AMT_CREDIT_MAX_OVERDUE_MEAN": 7195.5,
  "BURO_AMT_CREDIT_SUM_DEBT_MEAN": 0,
  "BURO_DAYS_CREDIT_MAX": -753,
  "BURO_DAYS_CREDIT_MEAN": -979.6666666666666,
  "CC_CNT_DRAWINGS_ATM_CURRENT_MEAN": 0.2666666666666666,
  "CLOSED_AMT_CREDIT_SUM_MAX": 38650.5,
  "CLOSED_DAYS_CREDIT_ENDDATE_MAX": -943,
  "CLOSED_DAYS_CREDIT_MAX": -1065,
  "CLOSED_DAYS_CREDIT_VAR": 256328,
  "CODE_GENDER": 1,
  "DAYS_BIRTH": -11716,
  "DAYS_EMPLOYED": -449,
  "DAYS_EMPLOYED_PERC": 0.0383236599522021,
  "DAYS_ID_PUBLISH": -3961,
  "DAYS_LAST_PHONE_CHANGE": -1420,
  "DAYS_REGISTRATION": -3997,
  "EXT_SOURCE_1": 0.3608707365728421,
  "EXT_SOURCE_2": 0.4285392216965799,
  "EXT_SOURCE_3": 0.7981372313187245,
  "INSTAL_AMT_PAYMENT_MEAN": 10274.82081081081,
  "INSTAL_AMT_PAYMENT_MIN": 2.7,
  "INSTAL_AMT_PAYMENT_SUM": 380168.37,
  "INSTAL_DBD_MAX": 60,
  "INSTAL_DBD_SUM": 833,
  "INSTAL_DPD_MEAN": 0.4594594594594595,
  "INSTAL_PAYMENT_PERC_MEAN": 0.945945945945946,
  "OWN_CAR_AGE": 9,
  "PAYMENT_RATE": 0.0710949347892023,
  "POS_MONTHS_BALANCE_SIZE": 40,
  "PREV_CNT_PAYMENT_MEAN": 15.142857142857142
}
    
    start = time.time()
    response = client.post("/predict", json=payload)
    duration = time.time() - start
    
    assert response.status_code == 200
    # L'API devrait répondre en moins d'une seconde
    assert duration < 1.0


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
